<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.18.3">
    <title>Contexts – Phoenix v1.4.0-dev</title>
    <link rel="stylesheet" href="dist/app-480ffdc169.css" />
    
    <script src="dist/sidebar_items-88fb2d3f91.js"></script>
    
    <link rel="stylesheet" href="dist/ex_doc_makeup-css.css"/>
    
    
  </head>
  <body data-type="extras">
    <script>try { if(localStorage.getItem('night-mode')) document.body.className += ' night-mode'; } catch (e) { }</script>

<div class="main">
<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" aria-hidden="true"></span>
  <span class="sr-only">Toggle Sidebar</span>
</button>
<button class="sidebar-button night-mode-toggle">
  <span class="icon-theme" aria-hidden="true"></span>
  <span class="sr-only">Toggle Theme</span>
</button>
<section class="sidebar">

  
  <a href="http://www.phoenixframework.org" class="sidebar-projectLink">
    <div class="sidebar-projectDetails">
      <h1 class="sidebar-projectName">
        Phoenix
      </h1>
      <h2 class="sidebar-projectVersion">
        v1.4.0-dev
      </h2>
    </div>
    
      <img src="assets/logo.png" alt="Phoenix" class="sidebar-projectImage">
    
  </a>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
    <input name="q" type="text" id="search-list" class="search-input" placeholder="Search" aria-label="Search" autocomplete="off" />
  </form>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">GUIDES</a></li>

    
      <li><a id="modules-list" href="#full-list">Modules</a></li>
    

    
      <li><a id="exceptions-list" href="#full-list">Exceptions</a></li>
    

    
      <li><a id="tasks-list" href="#full-list">Mix Tasks</a></li>
    
  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">


<h1>Contexts</h1>
<p>So far, we’ve built pages, wired up controller actions through our routers, and learned how Ecto allows data to be validated and persisted. Now it’s time to tie it all together by writing web-facing features that interact with our greater Elixir application.</p>
<p>When building a Phoenix project, we are first and foremost building an Elixir application. Phoenix’s job is to provide a web interface into our Elixir application. Naturally, we compose our applications with modules and functions, but simply defining a module with a few functions isn’t enough when designing an application. It’s vital to think about your application design when writing code. Let’s find out how.</p>
<blockquote><p>How to read this guide:
Using the context generators is a great way for beginners and intermediate Elixir programmers alike to get up and running quickly while thoughtfully designing their applications. This guide focuses on those readers. On the other hand, experienced developers may get more mileage from nuanced discussions around application design. For those readers, we include a frequently asked questions (FAQ) section at the end of the guide which brings different perspectives to some design decisions made throughout the guide. Beginners can safely skip the FAQ sections and return later when they’re ready to dig deeper.</p>
</blockquote>
<h2 id="thinking-about-design" class="section-heading">
  <a href="#thinking-about-design" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Thinking about design
</h2>

<p>Contexts are dedicated modules that expose and group related functionality. For example, anytime you call Elixir’s standard library, be it <a href="https://hexdocs.pm/logger/Logger.html#info/1"><code class="inline">Logger.info/1</code></a> or <a href="https://hexdocs.pm/elixir/Stream.html#map/2"><code class="inline">Stream.map/2</code></a>, you are accessing different contexts. Internally, Elixir’s logger is made of multiple modules, such as <a href="https://hexdocs.pm/logger/Logger.Config.html"><code class="inline">Logger.Config</code></a> and <code class="inline">Logger.Backends</code>, but we never interact with those modules directly. We call the <a href="https://hexdocs.pm/logger/Logger.html"><code class="inline">Logger</code></a> module the context, exactly because it exposes and groups all of the logging functionality.</p>
<p>Phoenix projects are structured like Elixir and any other Elixir project – we split our code into contexts. A context will group related functionality, such as posts and comments, often encapsulating patterns such as data access and data validation. By using contexts, we decouple and isolate our systems into manageable, independent parts.</p>
<p>Let’s use these ideas to build out our web application. Our goal is to build a user system as well as a basic content management system for adding and editing page content. Let’s get started!</p>
<h3 id="adding-an-accounts-context" class="section-heading">
  <a href="#adding-an-accounts-context" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Adding an Accounts Context
</h3>

<p>User accounts are often wide-reaching across a platform so it’s important to think upfront about writing a well-defined interface. With that in mind, our goal is to build an accounts API that handles creating, updating, and deleting user accounts, as well as authenticating user credentials. We’ll start off with basic features, but as we add authentication later, we’ll see how starting with a solid foundation allows us to grow our application naturally as we add functionality.</p>
<p>Phoenix includes the <code class="inline">phx.gen.html</code>, <code class="inline">phx.gen.json</code>, and <code class="inline">phx.gen.context</code> generators that apply the ideas of isolating functionality in our applications into contexts. These generators are a great way to hit the ground running while Phoenix nudges you in the right direction to grow your application. Let’s put these tools to use for our new user accounts context.</p>
<p>In order to run the context generators, we need to come up with a module name that groups the related functionality that we’re building. In the <a href="ecto.html">Ecto guide</a>, we saw how we can use Changesets and Repos to validate and persist user schemas, but we didn’t integrate this with our application at large. In fact, we didn’t think about where a “user” in our application should live at all. Let’s take a step back and think about the different parts of our system. We know that we’ll have users of our product. Along with users comes things like account login credentials and user registration. An <code class="inline">Accounts</code> context in our system is a natural place for our user functionality to live.</p>
<blockquote><p>Naming things is hard. If you’re stuck when trying to come up with a context name when the grouped functionality in your system isn’t yet clear, you can simply use the plural form of the resource you’re creating. For example, a <code class="inline">Users</code> context for managing users. As you grow your application and the parts of your system become clear, you can simply rename the context to a more refined name at a later time.</p>
</blockquote>
<p>Before we use the generators, we need to undo the changes we made in the Ecto guide, so we can give our user schema a proper home. Run these commands to undo our previous work:</p>
<pre><code class="console">$ rm lib/hello/user.ex
$ rm priv/repo/migrations/*_create_user.exs</code></pre>
<p>Next, let’s reset our database so we also discard the table we have just removed:</p>
<pre><code class="console">$ mix ecto.reset
Generated hello app
The database for Hello.Repo has been dropped
The database for Hello.Repo has been created

14:38:37.418 [info]  Already up</code></pre>
<p>Now we’re ready to create our accounts context. We’ll use the <code class="inline">phx.gen.html</code> task which creates a context module that wraps up Ecto access for creating, updating, and deleting users, along with web files like controllers and templates for the web interface into our context. Run the following command at your project root:</p>
<pre><code class="console">$ mix phx.gen.html Accounts User users name:string \
username:string:unique

* creating lib/hello_web/controllers/user_controller.ex
* creating lib/hello_web/templates/user/edit.html.eex
* creating lib/hello_web/templates/user/form.html.eex
* creating lib/hello_web/templates/user/index.html.eex
* creating lib/hello_web/templates/user/new.html.eex
* creating lib/hello_web/templates/user/show.html.eex
* creating lib/hello_web/views/user_view.ex
* creating test/hello_web/controllers/user_controller_test.exs
* creating lib/hello/accounts/user.ex
* creating priv/repo/migrations/20170629175236_create_users.exs
* creating lib/hello/accounts/accounts.ex
* injecting lib/hello/accounts/accounts.ex
* creating test/hello/accounts/accounts_test.exs
* injecting test/hello/accounts/accounts_test.exs

Add the resource to your browser scope in lib/hello_web/router.ex:

    resources &quot;/users&quot;, UserController


Remember to update your repository by running migrations:

    $ mix ecto.migrate
</code></pre>
<p>Phoenix generated the web files as expected in <code class="inline">lib/hello_web/</code>. We can also see our context files were generated inside a <code class="inline">lib/hello/accounts/</code> directory. Note the difference between <code class="inline">lib/hello</code> and <code class="inline">lib/hello_web</code>. We have an <code class="inline">Accounts</code> module to serve as the public API for account functionality, as well as an <code class="inline">Accounts.User</code> struct, which is an Ecto schema for casting and validating user account data. Phoenix also provided web and context tests for us, which we’ll look at later. For now, let’s follow the instructions and add the route according to the console instructions, in <code class="inline">lib/hello_web/router.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="w"> </span><span class="k" data-group-id="6530276529-1">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span><span class="w"> </span><span class="c1"># Use the default browser stack</span><span class="w">

    </span><span class="n">get</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">PageController</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">resources</span><span class="w"> </span><span class="s">&quot;/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">UserController</span><span class="w">
  </span><span class="k" data-group-id="6530276529-1">end</span></code></pre>
<p>With the new route in place, Phoenix reminds us to update our repo by running <code class="inline">mix ecto.migrate</code>. Let’s do that now:</p>
<pre><code class="console">$ mix ecto.migrate

[info]  == Running Hello.Repo.Migrations.CreateUsers.change/0 forward

[info]  create table users

[info]  create index users_username_index

[info]  == Migrated in 0.0s</code></pre>
<p>Before we jump into the generated code, let’s start the server with <code class="inline">mix phx.server</code> and visit <a href="http://localhost:4000/users">http://localhost:4000/users</a>. Let’s follow the “New User” link and click the “Submit” button without providing any input. We should be greeted with the following output:</p>
<pre><code class="">Oops, something went wrong! Please check the errors below.</code></pre>
<p>When we submit the form, we can see all the validation errors inline with the inputs. Nice! Out of the box, the context generator included the schema fields in our form template and we can see our default validations for required inputs are in effect. Let’s enter some example user data and resubmit the form:</p>
<pre><code class="">User created successfully.

Show User
Name: Chris McCord
Username: chrismccord</code></pre>
<p>If we follow the “Back” link, we get a list of all users, which should contain the one we just created. Likewise, we can update this record or delete it. Now that we’ve seen how it works in the browser, it’s time to take a look at the generated code.</p>
<h2 id="starting-with-generators" class="section-heading">
  <a href="#starting-with-generators" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Starting With Generators
</h2>

<p>That little <code class="inline">phx.gen.html</code> command packed a surprising punch. We got a lot of functionality out-of-the-box for creating, updating, and deleting users. This is far from a full-featured app, but remember, generators are first and foremost learning tools and a starting point for you to begin building real features. Code generation can’t solve all your problems, but it will teach you the ins and outs of Phoenix and nudge you towards the proper mind-set when designing your application.</p>
<p>Let’s first checkout the <code class="inline">UserController</code> that was generated in <code class="inline">lib/hello_web/controllers/user_controller.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserController</span><span class="w"> </span><span class="k" data-group-id="0595891783-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">index</span><span class="p" data-group-id="0595891783-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">_params</span><span class="p" data-group-id="0595891783-2">)</span><span class="w"> </span><span class="k" data-group-id="0595891783-3">do</span><span class="w">
    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">list_users</span><span class="p" data-group-id="0595891783-4">(</span><span class="p" data-group-id="0595891783-4">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="0595891783-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;index.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">users</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="0595891783-5">)</span><span class="w">
  </span><span class="k" data-group-id="0595891783-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">new</span><span class="p" data-group-id="0595891783-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">_params</span><span class="p" data-group-id="0595891783-6">)</span><span class="w"> </span><span class="k" data-group-id="0595891783-7">do</span><span class="w">
    </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">change_user</span><span class="p" data-group-id="0595891783-8">(</span><span class="p" data-group-id="0595891783-9">%</span><span class="nc" data-group-id="0595891783-9">User</span><span class="p" data-group-id="0595891783-9">{</span><span class="p" data-group-id="0595891783-9">}</span><span class="p" data-group-id="0595891783-8">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="0595891783-10">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;new.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="0595891783-10">)</span><span class="w">
  </span><span class="k" data-group-id="0595891783-7">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="0595891783-11">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0595891783-12">%{</span><span class="s">&quot;user&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user_params</span><span class="p" data-group-id="0595891783-12">}</span><span class="p" data-group-id="0595891783-11">)</span><span class="w"> </span><span class="k" data-group-id="0595891783-13">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">create_user</span><span class="p" data-group-id="0595891783-14">(</span><span class="n">user_params</span><span class="p" data-group-id="0595891783-14">)</span><span class="w"> </span><span class="k" data-group-id="0595891783-15">do</span><span class="w">
      </span><span class="p" data-group-id="0595891783-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="0595891783-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="0595891783-17">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;User created successfully.&quot;</span><span class="p" data-group-id="0595891783-17">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="0595891783-18">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">user_path</span><span class="p" data-group-id="0595891783-19">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="0595891783-19">)</span><span class="p" data-group-id="0595891783-18">)</span><span class="w">
      </span><span class="p" data-group-id="0595891783-20">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0595891783-21">%</span><span class="nc" data-group-id="0595891783-21">Ecto.Changeset</span><span class="p" data-group-id="0595891783-21">{</span><span class="p" data-group-id="0595891783-21">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="0595891783-20">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">render</span><span class="p" data-group-id="0595891783-22">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;new.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="0595891783-22">)</span><span class="w">
    </span><span class="k" data-group-id="0595891783-15">end</span><span class="w">
  </span><span class="k" data-group-id="0595891783-13">end</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="0595891783-1">end</span></code></pre>
<p>We’ve seen how controllers work in our <a href="controllers.html">controller guide</a>, so the code probably isn’t too surprising. What is worth noticing is how our controller calls into the <code class="inline">Accounts</code> context. We can see that the <code class="inline">index</code> action fetches a list of users with <code class="inline">Accounts.list_users/0</code>, and how users are persisted in the <code class="inline">create</code> action with <code class="inline">Accounts.create_user/1</code>. We haven’t yet looked at the accounts context, so we don’t yet know how user fetching and creation is happening under the hood – <em>but that’s the point</em>. Our Phoenix controller is the web interface into our greater application. It shouldn’t be concerned with the details of how users are fetched from the database or persisted into storage. We only care about telling our application to perform some work for us. This is great because our business logic and storage details are decoupled from the web layer of our application. If we move to a full-text storage engine later for fetching users instead of a SQL query, our controller doesn’t need to be changed. Likewise, we can reuse our context code from any other interface in our application, be it a channel, mix task, or long-running process importing CSV data.</p>
<p>In the case of our <code class="inline">create</code> action, when we successfully create a user, we use <code class="inline">Phoenix.Controller.put_flash/2</code> to show a success message, and then we redirect to the <code class="inline">user_path</code>’s show page. Conversely, if <code class="inline">Accounts.create_user/1</code> fails, we render our <code class="inline">&quot;new.html&quot;</code> template and pass along the Ecto changeset for the template to lift error messages from.</p>
<p>Next, let’s dig deeper and checkout our <code class="inline">Accounts</code> context in <code class="inline">lib/hello/accounts/accounts.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w"> </span><span class="k" data-group-id="7880021820-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  The Accounts context.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Query</span><span class="p">,</span><span class="w"> </span><span class="ss">warn</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Repo</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Returns the list of users.

  ## Examples

      iex&gt; list_users()
      [%User{}, ...]

  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list_users</span><span class="w"> </span><span class="k" data-group-id="7880021820-2">do</span><span class="w">
    </span><span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p" data-group-id="7880021820-3">(</span><span class="nc">User</span><span class="p" data-group-id="7880021820-3">)</span><span class="w">
  </span><span class="k" data-group-id="7880021820-2">end</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="7880021820-1">end</span></code></pre>
<p>This module will be the public API for all account functionality in our system. For example, in addition to user account management, we may also handle user login credentials, account preferences, and password reset generation. If we look at the <code class="inline">list_users/0</code> function, we can see the private details of user fetching. And it’s super simple. We have a call to <code class="inline">Repo.all(User)</code>. We saw how Ecto repo queries worked in <a href="ecto.html">the Ecto guide</a>, so this call should look familiar. Our <code class="inline">list_users</code> function is a generalized function specifying the <em>intent</em> of our code – namely to list users. The details of that intent where we use our Repo to fetch the users from our PostgreSQL database is hidden from our callers. This is a common theme we’ll see re-iterated as we use the Phoenix generators. Phoenix will push us to think about where we have different responsibilities in our application, and then to wrap up those different areas behind well-named modules and functions that make the intent of our code clear, while encapsulating the details.</p>
<p>Now we know how data is fetched, but how are users persisted? Let’s take a look at the <code class="inline">Accounts.create_user/1</code> function:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Creates a user.

  ## Examples

      iex&gt; create_user(%{field: value})
      {:ok, %User{}}

      iex&gt; create_user(%{field: bad_value})
      {:error, %Ecto.Changeset{}}

  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p" data-group-id="6123690580-1">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6123690580-2">%{</span><span class="p" data-group-id="6123690580-2">}</span><span class="p" data-group-id="6123690580-1">)</span><span class="w"> </span><span class="k" data-group-id="6123690580-3">do</span><span class="w">
    </span><span class="p" data-group-id="6123690580-4">%</span><span class="nc" data-group-id="6123690580-4">User</span><span class="p" data-group-id="6123690580-4">{</span><span class="p" data-group-id="6123690580-4">}</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">User</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="6123690580-5">(</span><span class="n">attrs</span><span class="p" data-group-id="6123690580-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="6123690580-6">(</span><span class="p" data-group-id="6123690580-6">)</span><span class="w">
  </span><span class="k" data-group-id="6123690580-3">end</span></code></pre>
<p>There’s more documentation than code here, but a couple of things are important to highlight. First, we can see again that our Ecto Repo is used under the hood for database access. You probably also noticed the call to <code class="inline">User.changeset/2</code>. We talked about changesets before, and now we see them in action in our context.</p>
<p>If we open up the <code class="inline">User</code> schema in <code class="inline">lib/hello/accounts/user.ex</code>, it will look immediately familiar:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w"> </span><span class="k" data-group-id="0973013740-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w">


  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="w"> </span><span class="k" data-group-id="0973013740-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:username</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="0973013740-3">(</span><span class="p" data-group-id="0973013740-3">)</span><span class="w">
  </span><span class="k" data-group-id="0973013740-2">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="0973013740-4">(</span><span class="p" data-group-id="0973013740-5">%</span><span class="nc" data-group-id="0973013740-5">User</span><span class="p" data-group-id="0973013740-5">{</span><span class="p" data-group-id="0973013740-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="0973013740-4">)</span><span class="w"> </span><span class="k" data-group-id="0973013740-6">do</span><span class="w">
    </span><span class="n">user</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="0973013740-7">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0973013740-8">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:username</span><span class="p" data-group-id="0973013740-8">]</span><span class="p" data-group-id="0973013740-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="0973013740-9">(</span><span class="p" data-group-id="0973013740-10">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:username</span><span class="p" data-group-id="0973013740-10">]</span><span class="p" data-group-id="0973013740-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">unique_constraint</span><span class="p" data-group-id="0973013740-11">(</span><span class="ss">:username</span><span class="p" data-group-id="0973013740-11">)</span><span class="w">
  </span><span class="k" data-group-id="0973013740-6">end</span><span class="w">
</span><span class="k" data-group-id="0973013740-1">end</span></code></pre>
<p>This is just what we saw before when we ran the <code class="inline">mix phx.gen.schema</code> task, except here we see a <code class="inline">@doc false</code> above our <code class="inline">changeset/2</code> function. This tells us that while this function is publicly callable, it’s not part of the public context API. Callers that build changesets do so via the context API. For example, <code class="inline">Accounts.create_user/1</code> calls into our <code class="inline">User.changeset/2</code> to build the changeset from user input. Callers, such as our controller actions, do not access <code class="inline">User.changeset/2</code> directly. All interaction with our user changesets is done through the public <code class="inline">Accounts</code> context.</p>
<h2 id="in-context-relationships" class="section-heading">
  <a href="#in-context-relationships" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  In-context Relationships
</h2>

<p>Our basic user account features are nice, but let’s take it up a notch by supporting user login credentials. We won’t implement a complete authentication system, but we’ll give ourselves a good start to grow such a system from. Many authentication solutions couple the user credentials to an account in a one-to-one fashion, but this often causes issues. For example, supporting different login methods, such as social login or recovery email addresses, will cause major code changes. Let’s set up a credentials association that will allow us to start off tracking a single credential per account, but easily support more features later.</p>
<p>For now, user credentials will contain only email information. Our first order of business is to decide where credentials live in the application. We have our <code class="inline">Accounts</code> context, which manages user accounts. User credentials is a natural fit here. Phoenix is also smart enough to generate code inside an existing context, which makes adding new resources to a context a breeze. Run the following command at your project root:</p>
<blockquote><p>Sometimes it may be tricky to determine if two resources belong to the same context or not. In those cases, prefer distinct contexts per resource and refactor later if necessary. Otherwise you can easily end-up with large contexts of loosely related entities. In other words: if you are unsure, you should prefer explicit modules (contexts) between resources.</p>
</blockquote>
<pre><code class="console">$ mix phx.gen.context Accounts Credential credentials \
email:string:unique user_id:references:users

* creating lib/hello/accounts/credential.ex
* creating priv/repo/migrations/20170629180555_create_credentials.exs
* injecting lib/hello/accounts/accounts.ex
* injecting test/hello/accounts/accounts_test.exs

Remember to update your repository by running migrations:

    $ mix ecto.migrate</code></pre>
<p>This time around, we used the <code class="inline">phx.gen.context</code> task, which is just like <code class="inline">phx.gen.html</code>, except it doesn’t generate the web files for us. Since we already have controllers and templates for managing users, we can integrate the new credential features into our existing web form.</p>
<p>We can see from the output that Phoenix generated an <code class="inline">accounts/credential.ex</code> file for our <code class="inline">Accounts.Credential</code> schema, as well as a migration. Notably, phoenix said it was <code class="inline">* injecting</code> code into the existing <code class="inline">accounts/accounts.ex</code> context file and test file. Since our <code class="inline">Accounts</code> module already exists, Phoenix knows to inject our code here.</p>
<p>Before we run our migrations, we need to make one change to the generated migration to enforce data integrity of user account credentials. In our case, we want a user’s credentials to be deleted when the parent user is removed. Make the following change to your <code class="inline">*_create_credentials.exs</code> migration file in <code class="inline">priv/repo/migrations/</code>:</p>
<pre><code class="diff">  def change do
    create table(:credentials) do
      add :email, :string
-     add :user_id, references(:users, on_delete: :nothing)
+     add :user_id, references(:users, on_delete: :delete_all),
+                   null: false

      timestamps()
    end

    create unique_index(:credentials, [:email])
    create index(:credentials, [:user_id])
  end</code></pre>
<p>We changed the <code class="inline">:on_delete</code> option from <code class="inline">:nothing</code> to <code class="inline">:delete_all</code>, which will generate a foreign key constraint that will delete all credentials for a given user when the user is removed from the database. Likewise, we also passed <code class="inline">null: false</code> to disallow creating credentials without an existing user. By using a database constraint, we enforce data integrity at the database level, rather than relying on ad-hoc and error-prone application logic.</p>
<p>Next, let’s migrate up our database as Phoenix instructed:</p>
<pre><code class="console">$ mix ecto.migrate
mix ecto.migrate
Compiling 2 files (.ex)
Generated hello app

[info]  == Running Hello.Repo.Migrations.CreateCredentials.change/0 forward

[info]  create table credentials

[info]  create index credentials_email_index

[info]  create index credentials_user_id_index

[info]  == Migrated in 0.0s</code></pre>
<p>Before we integrate credentials in the web layer, we need to let our context know how to associate users and credentials. First, open up <code class="inline">lib/accounts/user.ex</code> and add the following association:</p>
<pre><code class="nohighlight makeup"><span class="o">-</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="o">.</span><span class="p" data-group-id="8103034184-1">{</span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="nc">Credential</span><span class="p" data-group-id="8103034184-1">}</span><span class="w">


  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="w"> </span><span class="k" data-group-id="8103034184-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:username</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">has_one</span><span class="w"> </span><span class="ss">:credential</span><span class="p">,</span><span class="w"> </span><span class="nc">Credential</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="8103034184-3">(</span><span class="p" data-group-id="8103034184-3">)</span><span class="w">
  </span><span class="k" data-group-id="8103034184-2">end</span><span class="w">

</span></code></pre>
<p>We used <code class="inline">Ecto.Schema</code>’s <code class="inline">has_one</code> macro to let Ecto know how to associate our parent User to a child Credential. Next, let’s add the relationships in the opposite direction in <code class="inline">accounts/credential.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="o">-</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.Credential</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="o">.</span><span class="p" data-group-id="4728231464-1">{</span><span class="nc">Credential</span><span class="p">,</span><span class="w"> </span><span class="nc">User</span><span class="p" data-group-id="4728231464-1">}</span><span class="w">


  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;credentials&quot;</span><span class="w"> </span><span class="k" data-group-id="4728231464-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">field</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="nc">User</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="4728231464-3">(</span><span class="p" data-group-id="4728231464-3">)</span><span class="w">
  </span><span class="k" data-group-id="4728231464-2">end</span><span class="w">
</span></code></pre>
<p>We used the <code class="inline">belongs_to</code> macro to map our child relationship to the parent <code class="inline">User</code>. With our schema associations set up, let’s open up <code class="inline">accounts/accounts.ex</code> and make the following changes to the generated <code class="inline">list_users</code> and <code class="inline">get_user!</code>  functions:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list_users</span><span class="w"> </span><span class="k" data-group-id="7288762537-1">do</span><span class="w">
    </span><span class="nc">User</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p" data-group-id="7288762537-2">(</span><span class="p" data-group-id="7288762537-2">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="7288762537-3">(</span><span class="ss">:credential</span><span class="p" data-group-id="7288762537-3">)</span><span class="w">
  </span><span class="k" data-group-id="7288762537-1">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_user!</span><span class="p" data-group-id="7288762537-4">(</span><span class="n">id</span><span class="p" data-group-id="7288762537-4">)</span><span class="w"> </span><span class="k" data-group-id="7288762537-5">do</span><span class="w">
    </span><span class="nc">User</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="7288762537-6">(</span><span class="n">id</span><span class="p" data-group-id="7288762537-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="7288762537-7">(</span><span class="ss">:credential</span><span class="p" data-group-id="7288762537-7">)</span><span class="w">
  </span><span class="k" data-group-id="7288762537-5">end</span></code></pre>
<p>We rewrote the <code class="inline">list_users/0</code> and <code class="inline">get_user!/1</code> to preload the credential association whenever we fetch users. The Repo preload functionality fetches a schema’s association data from the database, then places it inside the schema. When operating on a collection, such as our query in <code class="inline">list_users</code>, Ecto can efficiently preload the associations in a single query. This allows us to represent our <code class="inline">%Accounts.User{}</code> structs as always containing credentials without the caller having to worry about fetching the extra data.</p>
<p>Next, let’s expose our new feature to the web by adding the credentials input to our user form. Open up <code class="inline">lib/hello_web/templates/user/form.html.eex</code> and key in the new credential form group above the submit button:</p>
<pre><code class="eex">  ...
+ &lt;div class=&quot;form-group&quot;&gt;
+   &lt;%= inputs_for f, :credential, fn cf -&gt; %&gt;
+     &lt;%= label cf, :email, class: &quot;control-label&quot; %&gt;
+     &lt;%= text_input cf, :email, class: &quot;form-control&quot; %&gt;
+     &lt;%= error_tag cf, :email %&gt;
+   &lt;% end %&gt;
+ &lt;/div&gt;

  &lt;div class=&quot;form-group&quot;&gt;
    &lt;%= submit &quot;Submit&quot;, class: &quot;btn btn-primary&quot; %&gt;
  &lt;/div&gt;</code></pre>
<p>We used <code class="inline">Phoenix.HTML</code>’s <code class="inline">inputs_for</code> function to add an associations nested fields within the parent form. Within the nested inputs, we rendered our credential’s email field and included the <code class="inline">label</code> and <code class="inline">error_tag</code> helpers just like our other inputs.</p>
<p>Next, let’s show the user’s email address in the user show template. Add the following code to <code class="inline">lib/hello_web/templates/user/show.html.eex</code>:</p>
<pre><code class="eex">  ...
+ &lt;li&gt;
+   &lt;strong&gt;Email:&lt;/strong&gt;
+   &lt;%= @user.credential.email %&gt;
+ &lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>Now if we visit <code class="inline">http://localhost:4000/users/new</code>, we’ll see the new email input, but if you try to save a user, you’ll find that the email field is ignored. No validations are run telling you it was blank and the data was not saved, and at the end you’ll get an exception <code class="inline">(UndefinedFunctionError) function nil.email/0 is undefined or private</code>. What gives?</p>
<p>We used Ecto’s <code class="inline">belongs_to</code> and <code class="inline">has_one</code> associations to wire-up how our data is related at the context level, but remember this is decoupled from our web-facing user input. To associate user input to our schema associations, we need to handle it the way we’ve handled other user input so far – in changesets. Remove the alias for Credential added by the generator and modify your <code class="inline">alias Hello.Accounts.User</code>, <code class="inline">create_user/1</code> and <code class="inline">update_user/2</code> functions in your <code class="inline">Accounts</code> context to build a changeset which knows how to cast user input with nested credential information:</p>
<pre><code class="nohighlight makeup"><span class="o">-</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="o">.</span><span class="p" data-group-id="2410528118-1">{</span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="nc">Credential</span><span class="p" data-group-id="2410528118-1">}</span><span class="w">
  </span><span class="n">...</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p" data-group-id="2410528118-2">(</span><span class="p" data-group-id="2410528118-3">%</span><span class="nc" data-group-id="2410528118-3">User</span><span class="p" data-group-id="2410528118-3">{</span><span class="p" data-group-id="2410528118-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="2410528118-2">)</span><span class="w"> </span><span class="k" data-group-id="2410528118-4">do</span><span class="w">
    </span><span class="n">user</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">User</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="2410528118-5">(</span><span class="n">attrs</span><span class="p" data-group-id="2410528118-5">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">cast_assoc</span><span class="p" data-group-id="2410528118-6">(</span><span class="ss">:credential</span><span class="p">,</span><span class="w"> </span><span class="ss">with</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">Credential</span><span class="o">.</span><span class="n">changeset</span><span class="o">/</span><span class="mi">2</span><span class="p" data-group-id="2410528118-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="2410528118-7">(</span><span class="p" data-group-id="2410528118-7">)</span><span class="w">
  </span><span class="k" data-group-id="2410528118-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p" data-group-id="2410528118-8">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="2410528118-9">%{</span><span class="p" data-group-id="2410528118-9">}</span><span class="p" data-group-id="2410528118-8">)</span><span class="w"> </span><span class="k" data-group-id="2410528118-10">do</span><span class="w">
    </span><span class="p" data-group-id="2410528118-11">%</span><span class="nc" data-group-id="2410528118-11">User</span><span class="p" data-group-id="2410528118-11">{</span><span class="p" data-group-id="2410528118-11">}</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">User</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="2410528118-12">(</span><span class="n">attrs</span><span class="p" data-group-id="2410528118-12">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">cast_assoc</span><span class="p" data-group-id="2410528118-13">(</span><span class="ss">:credential</span><span class="p">,</span><span class="w"> </span><span class="ss">with</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">Credential</span><span class="o">.</span><span class="n">changeset</span><span class="o">/</span><span class="mi">2</span><span class="p" data-group-id="2410528118-13">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="2410528118-14">(</span><span class="p" data-group-id="2410528118-14">)</span><span class="w">
  </span><span class="k" data-group-id="2410528118-10">end</span><span class="w">
  </span><span class="n">...</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts.Credential</span></code></pre>
<p>We updated the functions to pipe our user changeset into <code class="inline">Ecto.Changeset.cast_assoc/2</code>. Ecto’s <code class="inline">cast_assoc/2</code> allows us to tell the changeset how to cast user input to a schema relation. We also used the <code class="inline">:with</code> option to tell Ecto to use our <code class="inline">Credential.changeset/2</code> function to cast the data. This way, any validations we perform in <code class="inline">Credential.changeset/2</code> will be applied when saving the <code class="inline">User</code> changeset.</p>
<p>Finally, if you visit <code class="inline">http://localhost:4000/users/new</code> and attempt to save an empty email address, you’ll see the proper validation error message. If you enter valid information, the data will be casted and persisted properly.</p>
<pre><code class="">Show User
Name: Chris McCord
Username: chrismccord
Email: chris@example.com</code></pre>
<p>It’s not much to look at yet, but it works! We added relationships within our context complete with data integrity enforced by the database. Not bad. Let’s keep building!</p>
<h2 id="adding-account-functions" class="section-heading">
  <a href="#adding-account-functions" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Adding Account functions
</h2>

<p>As we’ve seen, your context modules are dedicated modules that expose and group related functionality. Phoenix generates generic functions, such as <code class="inline">list_users</code> and <code class="inline">update_user</code>, but they only serve as a basis for you to grow your business logic and application from. To begin extending our <code class="inline">Accounts</code> context with real features, let’s address an obvious issue of our application – we can create users with credentials in our system, but they have no way of signing in with those credentials. Building a complete user authentication system is beyond the scope of this guide, but let’s get started with a basic email-only sign-in page that allows us to track a current user’s session. This will let us focus on extending our <code class="inline">Accounts</code> context while giving you a good start to grow a complete authentication solution from.</p>
<p>To start, let’s think of a function name that describes what we want to accomplish. To authenticate a user by email address, we’ll need a way to lookup that user and verify their entered credentials are valid. We can do this by exposing a single function on our <code class="inline">Accounts</code> context.</p>
<pre><code class="nohighlight makeup"><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">authenticate_by_email_password</span><span class="p" data-group-id="3416595569-1">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p" data-group-id="3416595569-1">)</span></code></pre>
<p>That looks nice. A descriptive name that exposes the intent of our code is best. This function makes it crystal clear what purpose it serves, while allowing our caller to remain blissfully unaware of the internal details. Make the following additions to your <code class="inline">lib/hello/accounts/accounts.ex</code> file:</p>
<pre><code class="nohighlight makeup"><span class="kd">def</span><span class="w"> </span><span class="nf">authenticate_by_email_password</span><span class="p" data-group-id="9695612485-1">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">_password</span><span class="p" data-group-id="9695612485-1">)</span><span class="w"> </span><span class="k" data-group-id="9695612485-2">do</span><span class="w">
  </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="n">from</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">User</span><span class="p">,</span><span class="w">
      </span><span class="ss">inner_join</span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">assoc</span><span class="p" data-group-id="9695612485-3">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="ss">:credential</span><span class="p" data-group-id="9695612485-3">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">email</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">email</span><span class="w">

  </span><span class="k">case</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">one</span><span class="p" data-group-id="9695612485-4">(</span><span class="n">query</span><span class="p" data-group-id="9695612485-4">)</span><span class="w"> </span><span class="k" data-group-id="9695612485-5">do</span><span class="w">
    </span><span class="p" data-group-id="9695612485-6">%</span><span class="nc" data-group-id="9695612485-6">User</span><span class="p" data-group-id="9695612485-6">{</span><span class="p" data-group-id="9695612485-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9695612485-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="9695612485-7">}</span><span class="w">
    </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9695612485-8">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:unauthorized</span><span class="p" data-group-id="9695612485-8">}</span><span class="w">
  </span><span class="k" data-group-id="9695612485-5">end</span><span class="w">
</span><span class="k" data-group-id="9695612485-2">end</span></code></pre>
<p>We defined an <code class="inline">authenticate_by_email_password/2</code> function, which discards the password field for now, but you could integrate tools like <a href="https://github.com/ueberauth/guardian">guardian</a> or <a href="https://github.com/riverrun/comeonin">comeonin</a> as you continue building your application. All we need to do in our function is find the user with matching credentials and return the <code class="inline">%Accounts.User{}</code> struct in a <code class="inline">:ok</code> tuple, or an <code class="inline">{:error, :unauthorized}</code> value to let the caller know their authentication attempt has failed.</p>
<p>Now that we can authenticate a user from our context, let’s add a login page to our web layer. First create a new controller in <code class="inline">lib/hello_web/controllers/session_controller.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.SessionController</span><span class="w"> </span><span class="k" data-group-id="1073328488-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">new</span><span class="p" data-group-id="1073328488-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1073328488-2">)</span><span class="w"> </span><span class="k" data-group-id="1073328488-3">do</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="1073328488-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;new.html&quot;</span><span class="p" data-group-id="1073328488-4">)</span><span class="w">
  </span><span class="k" data-group-id="1073328488-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="1073328488-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1073328488-6">%{</span><span class="s">&quot;user&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="p" data-group-id="1073328488-7">%{</span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">password</span><span class="p" data-group-id="1073328488-7">}</span><span class="p" data-group-id="1073328488-6">}</span><span class="p" data-group-id="1073328488-5">)</span><span class="w"> </span><span class="k" data-group-id="1073328488-8">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">authenticate_by_email_password</span><span class="p" data-group-id="1073328488-9">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p" data-group-id="1073328488-9">)</span><span class="w"> </span><span class="k" data-group-id="1073328488-10">do</span><span class="w">
      </span><span class="p" data-group-id="1073328488-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="1073328488-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="1073328488-12">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Welcome back!&quot;</span><span class="p" data-group-id="1073328488-12">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_session</span><span class="p" data-group-id="1073328488-13">(</span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="1073328488-13">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">configure_session</span><span class="p" data-group-id="1073328488-14">(</span><span class="ss">renew</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1073328488-14">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="1073328488-15">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p" data-group-id="1073328488-15">)</span><span class="w">
      </span><span class="p" data-group-id="1073328488-16">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:unauthorized</span><span class="p" data-group-id="1073328488-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="1073328488-17">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bad email/password combination&quot;</span><span class="p" data-group-id="1073328488-17">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="1073328488-18">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">session_path</span><span class="p" data-group-id="1073328488-19">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:new</span><span class="p" data-group-id="1073328488-19">)</span><span class="p" data-group-id="1073328488-18">)</span><span class="w">
    </span><span class="k" data-group-id="1073328488-10">end</span><span class="w">
  </span><span class="k" data-group-id="1073328488-8">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="1073328488-20">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1073328488-20">)</span><span class="w"> </span><span class="k" data-group-id="1073328488-21">do</span><span class="w">
    </span><span class="n">conn</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">configure_session</span><span class="p" data-group-id="1073328488-22">(</span><span class="ss">drop</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1073328488-22">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="1073328488-23">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p" data-group-id="1073328488-23">)</span><span class="w">
  </span><span class="k" data-group-id="1073328488-21">end</span><span class="w">
</span><span class="k" data-group-id="1073328488-1">end</span></code></pre>
<p>We defined a <code class="inline">SessionController</code> to handle users signing in and out of the application. Our <code class="inline">new</code> action is responsible for simply rendering a “new session” form, which posts out to the create action of our controller. In <code class="inline">create</code>, we pattern match the form fields and call into our <code class="inline">Accounts.authenticate_by_email_password/2</code> that we just defined. If successful, we use <code class="inline">Plug.Conn.put_session/3</code> to place the authenticated user’s ID in the session, and redirect to the home page with a successful welcome message. We also called <code class="inline">configure_session(conn, renew: true)</code> before redirecting to avoid session fixation attacks. If authentication fails, we add a flash error message, and redirect to the sign-in page for the user to try again. To finish the controller, we support a <code class="inline">delete</code> action which simply calls <code class="inline">Plug.Conn.configure_session/2</code> to drop the session and redirect to the home page.</p>
<p>Next, let’s wire up our session routes in <code class="inline">lib/hello_web/router.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="w"> </span><span class="k" data-group-id="1000143607-1">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span><span class="w"> </span><span class="c1"># Use the default browser stack</span><span class="w">

    </span><span class="n">get</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">PageController</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="w">
    </span><span class="n">resources</span><span class="w"> </span><span class="s">&quot;/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">UserController</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">resources</span><span class="w"> </span><span class="s">&quot;/sessions&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">SessionController</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1000143607-2">[</span><span class="ss">:new</span><span class="p">,</span><span class="w"> </span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="ss">:delete</span><span class="p" data-group-id="1000143607-2">]</span><span class="p">,</span><span class="w">
                                              </span><span class="ss">singleton</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="1000143607-1">end</span></code></pre>
<p>We used <code class="inline">resources</code> to generate a set of routes under the <code class="inline">&quot;/session&quot;</code> path. This is what we’ve done for other routes, except this time we also passed the <code class="inline">:only</code> option to limit which routes are generated, since we only need to support <code class="inline">:new</code>, <code class="inline">:create</code>, and <code class="inline">:delete</code> actions. We also used the <code class="inline">singleton: true</code> option, which defines all the RESTful routes, but does not require a resource ID to be passed along in the URL. We don’t need an ID in the URL because our actions are always scoped to the “current” user in the system. The ID is always in the session. Before we finish our router, let’s add an authentication plug to the router that will allow us to lock down certain routes after a user has used our new session controller to sign-in. Add the following function to <code class="inline">lib/hello_web/router.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p" data-group-id="4738504677-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="4738504677-1">)</span><span class="w"> </span><span class="k" data-group-id="4738504677-2">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">get_session</span><span class="p" data-group-id="4738504677-3">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:user_id</span><span class="p" data-group-id="4738504677-3">)</span><span class="w"> </span><span class="k" data-group-id="4738504677-4">do</span><span class="w">
      </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Phoenix.Controller</span><span class="o">.</span><span class="n">put_flash</span><span class="p" data-group-id="4738504677-5">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Login required&quot;</span><span class="p" data-group-id="4738504677-5">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Phoenix.Controller</span><span class="o">.</span><span class="n">redirect</span><span class="p" data-group-id="4738504677-6">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p" data-group-id="4738504677-6">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">halt</span><span class="p" data-group-id="4738504677-7">(</span><span class="p" data-group-id="4738504677-7">)</span><span class="w">
      </span><span class="n">user_id</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">assign</span><span class="p" data-group-id="4738504677-8">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:current_user</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="o">.</span><span class="n">get_user!</span><span class="p" data-group-id="4738504677-9">(</span><span class="n">user_id</span><span class="p" data-group-id="4738504677-9">)</span><span class="p" data-group-id="4738504677-8">)</span><span class="w">
    </span><span class="k" data-group-id="4738504677-4">end</span><span class="w">
  </span><span class="k" data-group-id="4738504677-2">end</span></code></pre>
<p>We defined an <code class="inline">authenticate_user/2</code> plug in the router which simply uses <code class="inline">Plug.Conn.get_session/2</code> to check for a <code class="inline">:user_id</code> in the session. If we find one, it means a user has previously authenticated, and we call into <code class="inline">Hello.Accounts.get_user!/1</code> to place our <code class="inline">:current_user</code> into the connection assigns. If we don’t have a session, we add a flash error message, redirect to the homepage, and we use <code class="inline">Plug.Conn.halt/1</code> to halt further plugs downstream from being invoked. We won’t use this new plug quite yet, but it will be ready and waiting as we add authenticated routes in just a moment.</p>
<p>Lastly, we need <code class="inline">SessionView</code> to render a template for our login form. Create a new file in <code class="inline">lib/hello_web/views/session_view.ex:</code></p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.SessionView</span><span class="w"> </span><span class="k" data-group-id="7194948923-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:view</span><span class="w">
</span><span class="k" data-group-id="7194948923-1">end</span></code></pre>
<p>Next, add a new template in <code class="inline">lib/hello_web/templates/session/new.html.eex:</code></p>
<pre><code class="eex">&lt;h1&gt;Sign in&lt;/h1&gt;

&lt;%= form_for @conn, session_path(@conn, :create), [method: :post, as: :user], fn f -&gt; %&gt;
  &lt;div class=&quot;form-group&quot;&gt;
    &lt;%= text_input f, :email, placeholder: &quot;Email&quot; %&gt;
  &lt;/div&gt;

  &lt;div class=&quot;form-group&quot;&gt;
    &lt;%= password_input f, :password, placeholder: &quot;Password&quot; %&gt;
  &lt;/div&gt;

  &lt;div class=&quot;form-group&quot;&gt;
    &lt;%= submit &quot;Login&quot; %&gt;
  &lt;/div&gt;
&lt;% end %&gt;

&lt;%= form_for @conn, session_path(@conn, :delete), [method: :delete, as: :user], fn _ -&gt; %&gt;
  &lt;div class=&quot;form-group&quot;&gt;
    &lt;%= submit &quot;logout&quot; %&gt;
  &lt;/div&gt;
&lt;% end %&gt;</code></pre>
<p>To keep things simple, we added both our sign-in and sign-out forms in this template. For our sign-in form, we pass the <code class="inline">@conn</code> directly to <code class="inline">form_for</code>, pointing our form action at <code class="inline">session_path(@conn, :create)</code>. We also pass the <code class="inline">as: :user</code> option which tells Phoenix to wrap the form parameters inside a <code class="inline">&quot;user&quot;</code> key. Next, we used the <code class="inline">text_input</code> and <code class="inline">password_input</code> functions to send up an <code class="inline">&quot;email&quot;</code> and <code class="inline">&quot;password&quot;</code> parameter.</p>
<p>For logging out, we simply defined a form that sends the <code class="inline">DELETE</code> HTTP method to server’s session delete path. Now if you visit the sign-in page at http://localhost:4000/sessions/new and enter a bad email address, you should be greeted with your flash message. Entering a valid email address will redirect to the home page with a success flash notice.</p>
<p>With authentication in place, we’re in good shape to begin building out our next features.</p>
<h2 id="cross-context-dependencies" class="section-heading">
  <a href="#cross-context-dependencies" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Cross-context dependencies
</h2>

<p>Now that we have the beginnings of user account and credential features, let’s begin to work on the other main features of our application – managing page content. We want to support a content management system (CMS) where authors can create and edit pages of the site. While we could extend our <code class="inline">Accounts</code> context with CMS features, if we step back and think about the isolation of our application, we can see it doesn’t fit. An accounts system shouldn’t care at all about a CMS system. The responsibilities of our <code class="inline">Accounts</code> context is to manage users and their credentials, not handle page content changes. There’s a clear need here for a separate context to  handle these responsibilities. Let’s call it <code class="inline">CMS</code>.</p>
<p>Let’s create a <code class="inline">CMS</code> context to handle basic CMS duties. Before we write code, let’s imagine we have the following CMS feature requirements:</p>
<ol>
<li>Page creation and updates
</li>
<li>Pages belong to Authors who are responsible for publishing changes
</li>
<li>Author information should appear with the page, and include information such as author bio and role within the CMS, such as <code class="inline">&quot;editor&quot;</code>, <code class="inline">&quot;writer&quot;</code>, or <code class="inline">&quot;intern&quot;</code>.
</li>
</ol>
<p>From the description, it’s clear we need a <code class="inline">Page</code> resource for storing page information. What about our author information? While we could extend our existing <code class="inline">Accounts.User</code> schema to include information such as bio and role, that would violate the responsibilities we’ve set up for our contexts. Why should our Account system now be aware of author information? Worse, with a field like “role”, the CMS role in the system will likely conflict or be confused with other account roles for our application. There’s a better way.</p>
<p>Applications with “users” are naturally heavily user driven. After all, our software is typically designed to be used by human end-users one way or another. Instead of extending our <code class="inline">Accounts.User</code> struct to track every field and responsibility of our entire platform, it’s better to keep those responsibilities with the modules who own that functionality. In our case, we can create a <code class="inline">CMS.Author</code> struct that holds author specific fields as it relates to a CMS. Now we can place fields like “role” and “bio” here, where they naturally live. Likewise, we also gain specialized datastructures in our application that are suited to the domain that we are operating in, rather than a single <code class="inline">%User{}</code> in the system that has to be everything to everyone.</p>
<p>With our plan set, let’s get to work. Run the following command to generate our new context:</p>
<pre><code class="">$ mix phx.gen.html CMS Page pages title:string body:text \
views:integer --web CMS

* creating lib/hello_web/controllers/cms/page_controller.ex
* creating lib/hello_web/templates/cms/page/edit.html.eex
* creating lib/hello_web/templates/cms/page/form.html.eex
* creating lib/hello_web/templates/cms/page/index.html.eex
* creating lib/hello_web/templates/cms/page/new.html.eex
* creating lib/hello_web/templates/cms/page/show.html.eex
* creating lib/hello_web/views/cms/page_view.ex
* creating test/hello_web/controllers/cms/page_controller_test.exs
* creating lib/hello/cms/page.ex
* creating priv/repo/migrations/20170629195946_create_pages.exs
* creating lib/hello/cms/cms.ex
* injecting lib/hello/cms/cms.ex
* creating test/hello/cms/cms_test.exs
* injecting test/hello/cms/cms_test.exs

Add the resource to your CMS :browser scope in lib/hello_web/router.ex:

    scope &quot;/cms&quot;, HelloWeb.CMS, as: :cms do
      pipe_through :browser
      ...
      resources &quot;/pages&quot;, PageController
    end


Remember to update your repository by running migrations:

    $ mix ecto.migrate
</code></pre>
<p>The <code class="inline">views</code> attribute on the pages will not be updated directly by the user, so let’s remove it from the generated form. Open <code class="inline">lib/hello_web/templates/cms/page/form.html.eex</code> and remove this part:</p>
<pre><code class="eex">-  &lt;div class=&quot;form-group&quot;&gt;
-    &lt;%= label f, :views, class: &quot;control-label&quot; %&gt;
-    &lt;%= number_input f, :views, class: &quot;form-control&quot; %&gt;
-    &lt;%= error_tag f, :views %&gt;
-  &lt;/div&gt;</code></pre>
<p>Also, change <code class="inline">lib/hello/cms/page.ex</code> to remove <code class="inline">:views</code> from the permitted params:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="1517281005-1">(</span><span class="p" data-group-id="1517281005-2">%</span><span class="nc" data-group-id="1517281005-2">Page</span><span class="p" data-group-id="1517281005-2">{</span><span class="p" data-group-id="1517281005-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="1517281005-1">)</span><span class="w"> </span><span class="k" data-group-id="1517281005-3">do</span><span class="w">
    </span><span class="n">page</span><span class="w">
</span><span class="o">-</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="1517281005-4">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1517281005-5">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:views</span><span class="p" data-group-id="1517281005-5">]</span><span class="p" data-group-id="1517281005-4">)</span><span class="w">
</span><span class="o">-</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="1517281005-6">(</span><span class="p" data-group-id="1517281005-7">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:views</span><span class="p" data-group-id="1517281005-7">]</span><span class="p" data-group-id="1517281005-6">)</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="1517281005-8">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1517281005-9">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:body</span><span class="p" data-group-id="1517281005-9">]</span><span class="p" data-group-id="1517281005-8">)</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="1517281005-10">(</span><span class="p" data-group-id="1517281005-11">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:body</span><span class="p" data-group-id="1517281005-11">]</span><span class="p" data-group-id="1517281005-10">)</span><span class="w">
  </span><span class="k" data-group-id="1517281005-3">end</span></code></pre>
<p>Finally, open up the new file in <code class="inline">priv/repo/migrations</code> to ensure the <code class="inline">views</code> attribute will have a default value:</p>
<pre><code class="nohighlight makeup"><span class="w">    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="6175757613-1">(</span><span class="ss">:pages</span><span class="p" data-group-id="6175757613-1">)</span><span class="w"> </span><span class="k" data-group-id="6175757613-2">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:views</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:views</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="p">,</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">

      </span><span class="n">timestamps</span><span class="p" data-group-id="6175757613-3">(</span><span class="p" data-group-id="6175757613-3">)</span><span class="w">
    </span><span class="k" data-group-id="6175757613-2">end</span></code></pre>
<p>This time we passed the <code class="inline">--web</code> option to the generator. This tells Phoenix what namespace to use for the web modules, such as controllers and views. This is useful when you have conflicting resources in the system, such as our existing <code class="inline">PageController</code>, as well as a way to naturally namespace paths and functionality of different features, like a CMS system. Phoenix instructed us to add a new <code class="inline">scope</code> to the router for a <code class="inline">&quot;/cms&quot;</code> path prefix. Let’s copy paste the following into our <code class="inline">lib/hello_web/router.ex</code>, but we’ll make one modification to the <code class="inline">pipe_through</code> macro:</p>
<pre><code class="">  scope &quot;/cms&quot;, HelloWeb.CMS, as: :cms do
    pipe_through [:browser, :authenticate_user]

    resources &quot;/pages&quot;, PageController
  end
</code></pre>
<p>We added the <code class="inline">:authenticate_user</code> plug to require a signed-in user for all routes within this CMS scope. With our routes in place, we can migrate up the database:</p>
<pre><code class="">$ mix ecto.migrate

Compiling 12 files (.ex)
Generated hello app

[info]  == Running Hello.Repo.Migrations.CreatePages.change/0 forward

[info]  create table pages

[info]  == Migrated in 0.0s</code></pre>
<p>Now, let’s fire up the server with <code class="inline">mix phx.server</code> and visit <code class="inline">http://localhost:4000/cms/pages</code>. If we haven’t logged in yet, we’ll be redirected to the home page with a flash error message telling us to sign in. Let’s sign in at <code class="inline">http://localhost:4000/sessions/new</code>, then re-visit <code class="inline">http://localhost:4000/cms/pages</code>. Now that we’re authenticated, we should see a familiar resource listing for pages, with a <code class="inline">New Page</code> link.</p>
<p>Before we create any pages, we need page authors. Let’s run the <code class="inline">phx.gen.context</code> generator to generate an <code class="inline">Author</code> schema along with injected context functions:</p>
<pre><code class="">$ mix phx.gen.context CMS Author authors bio:text role:string \
genre:string user_id:references:users:unique

* creating lib/hello/cms/author.ex
* creating priv/repo/migrations/20170629200937_create_authors.exs
* injecting lib/hello/cms/cms.ex
* injecting test/hello/cms/cms_test.exs

Remember to update your repository by running migrations:

    $ mix ecto.migrate
</code></pre>
<p>We used the context generator to inject code, just like when we generated our credentials code. We added fields for the author bio, their role in the content management system, the genre the author writes in, and lastly a foreign key to a user in our accounts system. Since our accounts context is still the authority on end-users in our application, we will depend on it for our CMS authors. That said, any information specific to authors will stay in the authors schema. We could also decorate our <code class="inline">Author</code> with user account information by using virtual fields and never expose the <code class="inline">User</code> structure. This would ensure consumers of the CMS API are protected from changes in the <code class="inline">User</code> context.</p>
<p>Before we migrate our database, we need to handle data integrity once again in the newly generated <code class="inline">*_create_authors.exs</code> migration. Open up the new file in <code class="inline">priv/repo/migrations</code> and make the following change to the foreign key constraint:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="8431340234-1">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="8431340234-2">(</span><span class="ss">:authors</span><span class="p" data-group-id="8431340234-2">)</span><span class="w"> </span><span class="k" data-group-id="8431340234-3">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:bio</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:role</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:genre</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="8431340234-4">(</span><span class="ss">:users</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:nothing</span><span class="p" data-group-id="8431340234-4">)</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="8431340234-5">(</span><span class="ss">:users</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete_all</span><span class="p" data-group-id="8431340234-5">)</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">                   </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

      </span><span class="n">timestamps</span><span class="p" data-group-id="8431340234-6">(</span><span class="p" data-group-id="8431340234-6">)</span><span class="w">
    </span><span class="k" data-group-id="8431340234-3">end</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="n">unique_index</span><span class="p" data-group-id="8431340234-7">(</span><span class="ss">:authors</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8431340234-8">[</span><span class="ss">:user_id</span><span class="p" data-group-id="8431340234-8">]</span><span class="p" data-group-id="8431340234-7">)</span><span class="w">
  </span><span class="k" data-group-id="8431340234-1">end</span></code></pre>
<p>We used the <code class="inline">:delete_all</code> strategy again to enforce data integrity. This way, when a user is deleted from the application through <code class="inline">Accounts.delete_user/1)</code>, we don’t have to rely on application code in our <code class="inline">Accounts</code> context to worry about cleaning up the <code class="inline">CMS</code> author records. This keeps our application code decoupled and the data integrity enforcement where it belongs – in the database.</p>
<p>Before we continue, we have a final migration to generate. Now that we have an authors table, we can associate pages and authors. Let’s add an <code class="inline">author_id</code> field to the pages table. Run the following command to generate a new migration:</p>
<pre><code class="">$ mix ecto.gen.migration add_author_id_to_pages

* creating priv/repo/migrations
* creating priv/repo/migrations/20170629202117_add_author_id_to_pages.exs</code></pre>
<p>Now open up the new <code class="inline">*_add_author_id_to_pages.exs</code> file in <code class="inline">priv/repo/migrations</code> and key this in:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="0315186088-1">do</span><span class="w">
    </span><span class="n">alter</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="0315186088-2">(</span><span class="ss">:pages</span><span class="p" data-group-id="0315186088-2">)</span><span class="w"> </span><span class="k" data-group-id="0315186088-3">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:author_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="0315186088-4">(</span><span class="ss">:authors</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete_all</span><span class="p" data-group-id="0315186088-4">)</span><span class="p">,</span><span class="w">
                      </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="0315186088-3">end</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="n">index</span><span class="p" data-group-id="0315186088-5">(</span><span class="ss">:pages</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0315186088-6">[</span><span class="ss">:author_id</span><span class="p" data-group-id="0315186088-6">]</span><span class="p" data-group-id="0315186088-5">)</span><span class="w">
  </span><span class="k" data-group-id="0315186088-1">end</span></code></pre>
<p>We used the <code class="inline">alter</code> macro to add a new <code class="inline">author_id</code> field to the pages table, with a foreign key to our authors table. We also used the <code class="inline">on_delete: :delete_all</code> option again to prune any pages when a parent author is deleted from the application.</p>
<p>Now let’s migrate up:</p>
<pre><code class="">$ mix ecto.migrate

[info]  == Running Hello.Repo.Migrations.CreateAuthors.change/0 forward

[info]  create table authors

[info]  create index authors_user_id_index

[info]  == Migrated in 0.0s

[info]  == Running Hello.Repo.Migrations.AddAuthorIdToPages.change/0 forward

[info]  == Migrated in 0.0s</code></pre>
<p>With our database ready, let’s integrate authors and posts in the CMS system.</p>
<h2 id="cross-context-data" class="section-heading">
  <a href="#cross-context-data" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Cross-context data
</h2>

<p>Dependencies in your software are often unavoidable, but we can do our best to limit them where possible and lessen the maintenance burden when a dependency is necessary. So far, we’ve done a great job isolating the two main contexts of our application from each other, but now we have a necessary dependency to handle.</p>
<p>Our <code class="inline">Author</code> resource serves to keep the responsibilities of representing an author inside the CMS, but ultimately for an author to exist at all, an end-user represented by an <code class="inline">Accounts.User</code> must be present. Given this, our <code class="inline">CMS</code> context will have a data dependency on the <code class="inline">Accounts</code> context. With that in mind, we have two options. One is to expose APIs on the <code class="inline">Accounts</code> contexts that allows us to efficiently fetch user data for use in the CMS system, or we can use database joins to fetch the dependent data. Both are valid options given your tradeoffs and application size, but joining data from the database when you have a hard data dependency is just fine for a large class of applications. If you decide to break out coupled contexts into entirely separate applications and databases at a later time, you still gain the benefits of isolation. This is because your public context APIs will likely remain unchanged.</p>
<p>Now that we know where our data dependencies exist, let’s add our schema associations so we can tie pages to authors and authors to users. Make the following changes to <code class="inline">lib/hello/cms/page.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="o">-</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.CMS.Page</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.CMS</span><span class="o">.</span><span class="p" data-group-id="6174645037-1">{</span><span class="nc">Page</span><span class="p">,</span><span class="w"> </span><span class="nc">Author</span><span class="p" data-group-id="6174645037-1">}</span><span class="w">


  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;pages&quot;</span><span class="w"> </span><span class="k" data-group-id="6174645037-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:views</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:author</span><span class="p">,</span><span class="w"> </span><span class="nc">Author</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="6174645037-3">(</span><span class="p" data-group-id="6174645037-3">)</span><span class="w">
  </span><span class="k" data-group-id="6174645037-2">end</span></code></pre>
<p>We added a <code class="inline">belongs_to</code> relationships between pages and their authors.
Next, let’s add the association in the other direction in <code class="inline">lib/hello/cms/author.ex</code>:</p>
<pre><code class="nohighlight makeup"><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.CMS.Author</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.CMS</span><span class="o">.</span><span class="p" data-group-id="6090796325-1">{</span><span class="nc">Author</span><span class="p">,</span><span class="w"> </span><span class="nc">Page</span><span class="p" data-group-id="6090796325-1">}</span><span class="w">


  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;authors&quot;</span><span class="w"> </span><span class="k" data-group-id="6090796325-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:bio</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:genre</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:role</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">

</span><span class="o">-</span><span class="w">   </span><span class="n">field</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">has_many</span><span class="w"> </span><span class="ss">:pages</span><span class="p">,</span><span class="w"> </span><span class="nc">Page</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.Accounts.User</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="6090796325-3">(</span><span class="p" data-group-id="6090796325-3">)</span><span class="w">
  </span><span class="k" data-group-id="6090796325-2">end</span></code></pre>
<p>We added the <code class="inline">has_many</code> association for author pages, and then introduced our data dependency on the <code class="inline">Accounts</code> context by wiring up the <code class="inline">belongs_to</code> association to our <code class="inline">Accounts.User</code> schema.</p>
<p>With our associations in place, let’s update our <code class="inline">CMS</code> context to require an author when creating or updating a page. We’ll start off with data fetching changes. Open up your <code class="inline">CMS</code> context in <code class="inline">lib/hello/cms/cms.ex</code> and replace the <code class="inline">list_pages/0</code>, and <code class="inline">get_page!/1</code> functions with the following definitions:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.CMS</span><span class="o">.</span><span class="p" data-group-id="1830450439-1">{</span><span class="nc">Page</span><span class="p">,</span><span class="w"> </span><span class="nc">Author</span><span class="p" data-group-id="1830450439-1">}</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list_pages</span><span class="w"> </span><span class="k" data-group-id="1830450439-2">do</span><span class="w">
    </span><span class="nc">Page</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p" data-group-id="1830450439-3">(</span><span class="p" data-group-id="1830450439-3">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="1830450439-4">(</span><span class="ss">author</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1830450439-5">[</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="ss">:credential</span><span class="p" data-group-id="1830450439-5">]</span><span class="p" data-group-id="1830450439-4">)</span><span class="w">
  </span><span class="k" data-group-id="1830450439-2">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_page!</span><span class="p" data-group-id="1830450439-6">(</span><span class="n">id</span><span class="p" data-group-id="1830450439-6">)</span><span class="w"> </span><span class="k" data-group-id="1830450439-7">do</span><span class="w">
    </span><span class="nc">Page</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="1830450439-8">(</span><span class="n">id</span><span class="p" data-group-id="1830450439-8">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="1830450439-9">(</span><span class="ss">author</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1830450439-10">[</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="ss">:credential</span><span class="p" data-group-id="1830450439-10">]</span><span class="p" data-group-id="1830450439-9">)</span><span class="w">
  </span><span class="k" data-group-id="1830450439-7">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_author!</span><span class="p" data-group-id="1830450439-11">(</span><span class="n">id</span><span class="p" data-group-id="1830450439-11">)</span><span class="w"> </span><span class="k" data-group-id="1830450439-12">do</span><span class="w">
    </span><span class="nc">Author</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="1830450439-13">(</span><span class="n">id</span><span class="p" data-group-id="1830450439-13">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="1830450439-14">(</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="ss">:credential</span><span class="p" data-group-id="1830450439-14">)</span><span class="w">
  </span><span class="k" data-group-id="1830450439-12">end</span></code></pre>
<p>We started by rewriting the <code class="inline">list_pages/0</code> function to preload the associated author, user, and credential data from the database. Next, we rewrote <code class="inline">get_page!/1</code> and <code class="inline">get_author!/1</code> to also preload the necessary data.</p>
<p>With our data access functions in place, let’s turn our focus towards persistence. We can fetch authors alongside pages, but we haven’t yet allowed authors to be persisted when we create or edit pages. Let’s fix that. Open up <code class="inline">lib/hello/cms/cms.ex</code> and make the following changes:</p>
<pre><code class="nohighlight makeup"><span class="kd">def</span><span class="w"> </span><span class="nf">create_page</span><span class="p" data-group-id="1901077559-1">(</span><span class="p" data-group-id="1901077559-2">%</span><span class="nc" data-group-id="1901077559-2">Author</span><span class="p" data-group-id="1901077559-2">{</span><span class="p" data-group-id="1901077559-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">author</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="1901077559-3">%{</span><span class="p" data-group-id="1901077559-3">}</span><span class="p" data-group-id="1901077559-1">)</span><span class="w"> </span><span class="k" data-group-id="1901077559-4">do</span><span class="w">
  </span><span class="p" data-group-id="1901077559-5">%</span><span class="nc" data-group-id="1901077559-5">Page</span><span class="p" data-group-id="1901077559-5">{</span><span class="p" data-group-id="1901077559-5">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Page</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="1901077559-6">(</span><span class="n">attrs</span><span class="p" data-group-id="1901077559-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_change</span><span class="p" data-group-id="1901077559-7">(</span><span class="ss">:author_id</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="1901077559-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="1901077559-8">(</span><span class="p" data-group-id="1901077559-8">)</span><span class="w">
</span><span class="k" data-group-id="1901077559-4">end</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">ensure_author_exists</span><span class="p" data-group-id="1901077559-9">(</span><span class="p" data-group-id="1901077559-10">%</span><span class="nc" data-group-id="1901077559-10">Accounts.User</span><span class="p" data-group-id="1901077559-10">{</span><span class="p" data-group-id="1901077559-10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="1901077559-9">)</span><span class="w"> </span><span class="k" data-group-id="1901077559-11">do</span><span class="w">
  </span><span class="p" data-group-id="1901077559-12">%</span><span class="nc" data-group-id="1901077559-12">Author</span><span class="p" data-group-id="1901077559-12">{</span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="1901077559-12">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="1901077559-13">(</span><span class="p" data-group-id="1901077559-13">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">unique_constraint</span><span class="p" data-group-id="1901077559-14">(</span><span class="ss">:user_id</span><span class="p" data-group-id="1901077559-14">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="1901077559-15">(</span><span class="p" data-group-id="1901077559-15">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">handle_existing_author</span><span class="p" data-group-id="1901077559-16">(</span><span class="p" data-group-id="1901077559-16">)</span><span class="w">
</span><span class="k" data-group-id="1901077559-11">end</span><span class="w">
</span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_existing_author</span><span class="p" data-group-id="1901077559-17">(</span><span class="p" data-group-id="1901077559-18">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p" data-group-id="1901077559-18">}</span><span class="p" data-group-id="1901077559-17">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">author</span><span class="w">
</span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_existing_author</span><span class="p" data-group-id="1901077559-19">(</span><span class="p" data-group-id="1901077559-20">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="1901077559-20">}</span><span class="p" data-group-id="1901077559-19">)</span><span class="w"> </span><span class="k" data-group-id="1901077559-21">do</span><span class="w">
  </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get_by!</span><span class="p" data-group-id="1901077559-22">(</span><span class="nc">Author</span><span class="p">,</span><span class="w"> </span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">user_id</span><span class="p" data-group-id="1901077559-22">)</span><span class="w">
</span><span class="k" data-group-id="1901077559-21">end</span></code></pre>
<p>There’s a bit of a code here, so let’s break it down. First, we rewrote the <code class="inline">create_page</code> function to require a <code class="inline">CMS.Author</code> struct, which represents the author publishing the post. We then take our changeset and pass it to <code class="inline">Ecto.Changeset.put_change/2</code> to place the <code class="inline">author_id</code> association in the changeset. Next, we use <code class="inline">Repo.insert</code> to insert the new page into the database, containing our associated <code class="inline">author_id</code>.</p>
<p>Our CMS system requires an author to exist for any end-user before they publish posts, so we added an <code class="inline">ensure_author_exists</code> function to programmatically allow authors to be created. Our new function accepts an <code class="inline">Accounts.User</code> struct and either finds the existing author in the application with that <code class="inline">user.id</code>, or creates a new author for the user. Our authors table has a unique constraint on the <code class="inline">user_id</code> foreign key, so we are protected from a race condition allowing duplicate authors. That said, we still need to protect ourselves from racing the insert of another user. To accomplish this, we use a purpose-built changeset with <code class="inline">Ecto.Changeset.change/1</code> which accepts a new <code class="inline">Author</code> struct with our <code class="inline">user_id</code>. The changeset’s only purpose is to convert a unique constraint violation into an error we can handle. After attempting to insert the new author with <code class="inline">Repo.insert/1</code>, we pipe to <code class="inline">handle_existing_author/1</code> which matches on the success and error cases. For the success case, we are done and simply return the created author, otherwise we use <code class="inline">Repo.get_by!</code> to fetch the author for the <code class="inline">user_id</code> that already exists.</p>
<p>That wraps up our <code class="inline">CMS</code> changes. Now, let’s update our web layer to support our additions. Before we update our individual CMS controller actions, we need to make a couple of additions to the <code class="inline">CMS.PageController</code> plug pipeline. First, we must ensure an author exists for end-users accessing the CMS, and we need to authorize access to page owners.</p>
<p>Open up your generated <code class="inline">lib/hello_web/controllers/cms/page_controller.ex</code> and make the following additions:</p>
<pre><code class="nohighlight makeup"><span class="w">
  </span><span class="n">plug</span><span class="w"> </span><span class="ss">:require_existing_author</span><span class="w">
  </span><span class="n">plug</span><span class="w"> </span><span class="ss">:authorize_page</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p" data-group-id="9698622878-1">[</span><span class="ss">:edit</span><span class="p">,</span><span class="w"> </span><span class="ss">:update</span><span class="p">,</span><span class="w"> </span><span class="ss">:delete</span><span class="p" data-group-id="9698622878-1">]</span><span class="w">

  </span><span class="n">...</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">require_existing_author</span><span class="p" data-group-id="9698622878-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="9698622878-2">)</span><span class="w"> </span><span class="k" data-group-id="9698622878-3">do</span><span class="w">
    </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">ensure_author_exists</span><span class="p" data-group-id="9698622878-4">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_user</span><span class="p" data-group-id="9698622878-4">)</span><span class="w">
    </span><span class="n">assign</span><span class="p" data-group-id="9698622878-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:current_author</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p" data-group-id="9698622878-5">)</span><span class="w">
  </span><span class="k" data-group-id="9698622878-3">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">authorize_page</span><span class="p" data-group-id="9698622878-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="9698622878-6">)</span><span class="w"> </span><span class="k" data-group-id="9698622878-7">do</span><span class="w">
    </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">get_page!</span><span class="p" data-group-id="9698622878-8">(</span><span class="n">conn</span><span class="o">.</span><span class="n">params</span><span class="p" data-group-id="9698622878-9">[</span><span class="s">&quot;id&quot;</span><span class="p" data-group-id="9698622878-9">]</span><span class="p" data-group-id="9698622878-8">)</span><span class="w">

    </span><span class="k">if</span><span class="w"> </span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_author</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">page</span><span class="o">.</span><span class="n">author_id</span><span class="w"> </span><span class="k" data-group-id="9698622878-10">do</span><span class="w">
      </span><span class="n">assign</span><span class="p" data-group-id="9698622878-11">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:page</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="9698622878-11">)</span><span class="w">
    </span><span class="k" data-group-id="9698622878-10">else</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="9698622878-12">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;You can&#39;t modify that page&quot;</span><span class="p" data-group-id="9698622878-12">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="9698622878-13">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">cms_page_path</span><span class="p" data-group-id="9698622878-14">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="9698622878-14">)</span><span class="p" data-group-id="9698622878-13">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">halt</span><span class="p" data-group-id="9698622878-15">(</span><span class="p" data-group-id="9698622878-15">)</span><span class="w">
    </span><span class="k" data-group-id="9698622878-10">end</span><span class="w">
  </span><span class="k" data-group-id="9698622878-7">end</span></code></pre>
<p>We added two new plugs to our <code class="inline">CMS.PageController</code>. The first plug, <code class="inline">:require_existing_author</code>, runs for every action in this controller. The <code class="inline">require_existing_author/2</code> plug calls into our <code class="inline">CMS.ensure_author_exists/1</code> and passes in the <code class="inline">current_user</code> from the connection assigns. After finding or creating the author, we use <code class="inline">Plug.Conn.assign/3</code> to place a <code class="inline">:current_author</code> key into the assigns for use downstream.</p>
<p>Next, we added an <code class="inline">:authorized_page</code> plug that makes use of plug’s guard clause feature where we can limit the plug to only certain actions. The definition for our <code class="inline">authorize_page/2</code> plug first fetches the page from the connection params, then does an authorization check against the <code class="inline">current_author</code>. If our current author’s ID matches the fetched page ID, we have verified the page’s owner is accessing the page and we simply assign the <code class="inline">page</code> into the connection assigns to be used in the controller action. If our authorization fails, we add a flash error message, redirect to the page index screen, and then call <code class="inline">Plug.Conn.halt/1</code> to prevent the plug pipeline from continuing and invoking the controller action.</p>
<p>With our new plugs in place, we can now modify our <code class="inline">create</code>, <code class="inline">edit</code>, <code class="inline">update</code>, and <code class="inline">delete</code> actions to make use of the new values in the connection assigns:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">edit</span><span class="p" data-group-id="9939895814-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="9939895814-1">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-2">do</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">get_page!</span><span class="p" data-group-id="9939895814-3">(</span><span class="n">id</span><span class="p" data-group-id="9939895814-3">)</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">change_page</span><span class="p" data-group-id="9939895814-4">(</span><span class="n">page</span><span class="p" data-group-id="9939895814-4">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">change_page</span><span class="p" data-group-id="9939895814-5">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">page</span><span class="p" data-group-id="9939895814-5">)</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">render</span><span class="p" data-group-id="9939895814-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;edit.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">page</span><span class="p">:</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-6">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">render</span><span class="p" data-group-id="9939895814-7">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;edit.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-7">)</span><span class="w">
  </span><span class="k" data-group-id="9939895814-2">end</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="9939895814-8">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-9">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;page&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-9">}</span><span class="p" data-group-id="9939895814-8">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-10">do</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="9939895814-11">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-12">%{</span><span class="s">&quot;page&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-12">}</span><span class="p" data-group-id="9939895814-11">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-13">do</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">create_page</span><span class="p" data-group-id="9939895814-14">(</span><span class="n">page_params</span><span class="p" data-group-id="9939895814-14">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-15">do</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">create_page</span><span class="p" data-group-id="9939895814-16">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_author</span><span class="p">,</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-16">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-17">do</span><span class="w">
      </span><span class="p" data-group-id="9939895814-18">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="9939895814-18">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="9939895814-19">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Page created successfully.&quot;</span><span class="p" data-group-id="9939895814-19">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="9939895814-20">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">cms_page_path</span><span class="p" data-group-id="9939895814-21">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="9939895814-21">)</span><span class="p" data-group-id="9939895814-20">)</span><span class="w">
      </span><span class="p" data-group-id="9939895814-22">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-23">%</span><span class="nc" data-group-id="9939895814-23">Ecto.Changeset</span><span class="p" data-group-id="9939895814-23">{</span><span class="p" data-group-id="9939895814-23">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-22">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">render</span><span class="p" data-group-id="9939895814-24">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;new.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-24">)</span><span class="w">
    </span><span class="k" data-group-id="9939895814-17">end</span><span class="w">
  </span><span class="k" data-group-id="9939895814-15">end</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">update</span><span class="p" data-group-id="9939895814-25">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-26">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;page&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-26">}</span><span class="p" data-group-id="9939895814-25">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-27">do</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">update</span><span class="p" data-group-id="9939895814-28">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-29">%{</span><span class="s">&quot;page&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-29">}</span><span class="p" data-group-id="9939895814-28">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-30">do</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">get_page!</span><span class="p" data-group-id="9939895814-31">(</span><span class="n">id</span><span class="p" data-group-id="9939895814-31">)</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">update_page</span><span class="p" data-group-id="9939895814-32">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-32">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-33">do</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">update_page</span><span class="p" data-group-id="9939895814-34">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">page_params</span><span class="p" data-group-id="9939895814-34">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-35">do</span><span class="w">
      </span><span class="p" data-group-id="9939895814-36">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="9939895814-36">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="9939895814-37">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Page updated successfully.&quot;</span><span class="p" data-group-id="9939895814-37">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="9939895814-38">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">cms_page_path</span><span class="p" data-group-id="9939895814-39">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="9939895814-39">)</span><span class="p" data-group-id="9939895814-38">)</span><span class="w">
      </span><span class="p" data-group-id="9939895814-40">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-41">%</span><span class="nc" data-group-id="9939895814-41">Ecto.Changeset</span><span class="p" data-group-id="9939895814-41">{</span><span class="p" data-group-id="9939895814-41">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-40">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
</span><span class="o">-</span><span class="w">       </span><span class="n">render</span><span class="p" data-group-id="9939895814-42">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;edit.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">page</span><span class="p">:</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-42">)</span><span class="w">
</span><span class="o">+</span><span class="w">       </span><span class="n">render</span><span class="p" data-group-id="9939895814-43">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;edit.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9939895814-43">)</span><span class="w">
    </span><span class="k" data-group-id="9939895814-35">end</span><span class="w">
  </span><span class="k" data-group-id="9939895814-33">end</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="9939895814-44">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9939895814-45">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="9939895814-45">}</span><span class="p" data-group-id="9939895814-44">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-46">do</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="9939895814-47">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="9939895814-47">)</span><span class="w"> </span><span class="k" data-group-id="9939895814-48">do</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">get_page!</span><span class="p" data-group-id="9939895814-49">(</span><span class="n">id</span><span class="p" data-group-id="9939895814-49">)</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="p" data-group-id="9939895814-50">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">_page</span><span class="p" data-group-id="9939895814-50">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">delete_page</span><span class="p" data-group-id="9939895814-51">(</span><span class="n">page</span><span class="p" data-group-id="9939895814-51">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="p" data-group-id="9939895814-52">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">_page</span><span class="p" data-group-id="9939895814-52">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">delete_page</span><span class="p" data-group-id="9939895814-53">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">page</span><span class="p" data-group-id="9939895814-53">)</span><span class="w">

    </span><span class="n">conn</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="9939895814-54">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Page deleted successfully.&quot;</span><span class="p" data-group-id="9939895814-54">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="9939895814-55">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">cms_page_path</span><span class="p" data-group-id="9939895814-56">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="9939895814-56">)</span><span class="p" data-group-id="9939895814-55">)</span><span class="w">
  </span><span class="k" data-group-id="9939895814-48">end</span></code></pre>
<p>We modified the <code class="inline">create</code> action to grab our <code class="inline">current_author</code> from the connection assigns, which was placed there by our <code class="inline">require_existing_author</code> plug. We then passed our current author into <code class="inline">CMS.create_page</code> where it will be used to associate the author to the new page. Next, we changed the <code class="inline">update</code> action to pass the <code class="inline">conn.assigns.page</code> into <code class="inline">CMS.update_page/2</code>, rather than fetching it directly in the action. Since our <code class="inline">authorize_page</code> plug already fetched the page and placed it into the assigns, we can simply reference it here in the action. Similarly, we updated the <code class="inline">delete</code> action to pass the <code class="inline">conn.assigns.page</code> into the <code class="inline">CMS</code> rather than fetching the page in the action.</p>
<p>To complete the web changes, let’s display the author when showing a page. First, open up <code class="inline">lib/hello_web/views/cms/page_view.ex</code> and add a helper function to handle formatting the author’s name:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.CMS.PageView</span><span class="w"> </span><span class="k" data-group-id="2429015303-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:view</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.CMS</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">author_name</span><span class="p" data-group-id="2429015303-2">(</span><span class="p" data-group-id="2429015303-3">%</span><span class="nc" data-group-id="2429015303-3">CMS.Page</span><span class="p" data-group-id="2429015303-3">{</span><span class="ss">author</span><span class="p">:</span><span class="w"> </span><span class="n">author</span><span class="p" data-group-id="2429015303-3">}</span><span class="p" data-group-id="2429015303-2">)</span><span class="w"> </span><span class="k" data-group-id="2429015303-4">do</span><span class="w">
    </span><span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="w">
  </span><span class="k" data-group-id="2429015303-4">end</span><span class="w">
</span><span class="k" data-group-id="2429015303-1">end</span></code></pre>
<p>Next, let’s open up <code class="inline">lib/hello_web/templates/cms/page/show.html.eex</code> and make use of our new function:</p>
<pre><code class="diff">+ &lt;li&gt;
+   &lt;strong&gt;Author:&lt;/strong&gt;
+   &lt;%= author_name(@page) %&gt;
+ &lt;/li&gt;
&lt;/ul&gt;</code></pre>
<p>Now, fire up your server with <code class="inline">mix phx.server</code> and try it out. Visit <code class="inline">http://localhost:4000/cms/pages/new</code> and save a new page.</p>
<pre><code class="">Page created successfully.

Show Page Title: Home
Body: Welcome to Phoenix!
Views: 0
Author: Chris</code></pre>
<p>And it works! We now have two isolated contexts responsible for user accounts and content management. We coupled the content management system to accounts where necessary, while keeping each system isolated wherever possible. This gives us a great base to grow our application from.</p>
<h2 id="adding-cms-functions" class="section-heading">
  <a href="#adding-cms-functions" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Adding CMS functions
</h2>

<p>Just like we extended our <code class="inline">Accounts</code> context with new application-specific functions like <code class="inline">Accounts.authenticate_by_email_password/2</code>, let’s extend our generated <code class="inline">CMS</code> context with new functionality. For any CMS system, the ability to track how many times a page has been viewed is essential for popularity ranks. While we could try to use the existing <code class="inline">CMS.update_page</code> function, along the lines of <code class="inline">CMS.update_page(user, page, %{views: page.views + 1})</code>, this would not only be prone to race conditions, but it would also require the caller to know too much about our CMS system. To see why the race condition exists, let’s walk through the possible execution of events:</p>
<p>Intuitively, you would assume the following events:</p>
<ol>
<li>User 1 loads the page with count of 13
</li>
<li>User 1 saves the page with count of 14
</li>
<li>User 2 loads the page with count of 14
</li>
<li>User 2 loads the page with count of 15
</li>
</ol>
<p>While in practice this would happen:</p>
<ol>
<li>User 1 loads the page with count of 13
</li>
<li>User 2 loads the page with count of 13
</li>
<li>User 1 saves the page with count of 14
</li>
<li>User 2 saves the page with count of 14
</li>
</ol>
<p>The race conditions would make this an unreliable way to update the existing table since multiple callers may be updating out of date view values. There’s a better way.</p>
<p>Again, let’s think of a function name that describes what we want to accomplish.</p>
<pre><code class="nohighlight makeup"><span class="o">&gt;</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">inc_page_views</span><span class="p" data-group-id="3921054950-1">(</span><span class="n">page</span><span class="p" data-group-id="3921054950-1">)</span></code></pre>
<p>That looks great. Our callers will have no confusion over what this function does and we can wrap up the increment in an atomic operation to prevent race conditions.</p>
<p>Open up your CMS context (<code class="inline">lib/hello/cms/cms.ex</code>), and add this new function:</p>
<pre><code class="nohighlight makeup"><span class="kd">def</span><span class="w"> </span><span class="nf">inc_page_views</span><span class="p" data-group-id="5708936496-1">(</span><span class="p" data-group-id="5708936496-2">%</span><span class="nc" data-group-id="5708936496-2">Page</span><span class="p" data-group-id="5708936496-2">{</span><span class="p" data-group-id="5708936496-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="5708936496-1">)</span><span class="w"> </span><span class="k" data-group-id="5708936496-3">do</span><span class="w">
  </span><span class="p" data-group-id="5708936496-4">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5708936496-5">[</span><span class="p" data-group-id="5708936496-6">%</span><span class="nc" data-group-id="5708936496-6">Page</span><span class="p" data-group-id="5708936496-6">{</span><span class="ss">views</span><span class="p">:</span><span class="w"> </span><span class="n">views</span><span class="p" data-group-id="5708936496-6">}</span><span class="p" data-group-id="5708936496-5">]</span><span class="p" data-group-id="5708936496-4">}</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update_all</span><span class="p" data-group-id="5708936496-7">(</span><span class="w">
      </span><span class="n">from</span><span class="p" data-group-id="5708936496-8">(</span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Page</span><span class="p">,</span><span class="w"> </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="5708936496-8">)</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="5708936496-9">[</span><span class="ss">inc</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5708936496-10">[</span><span class="ss">views</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5708936496-10">]</span><span class="p" data-group-id="5708936496-9">]</span><span class="p">,</span><span class="w"> </span><span class="ss">returning</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5708936496-11">[</span><span class="ss">:views</span><span class="p" data-group-id="5708936496-11">]</span><span class="p" data-group-id="5708936496-7">)</span><span class="w">

  </span><span class="n">put_in</span><span class="p" data-group-id="5708936496-12">(</span><span class="n">page</span><span class="o">.</span><span class="n">views</span><span class="p">,</span><span class="w"> </span><span class="n">views</span><span class="p" data-group-id="5708936496-12">)</span><span class="w">
</span><span class="k" data-group-id="5708936496-3">end</span></code></pre>
<p>We built a query for fetching the current page given its ID which we pass to <code class="inline">Repo.update_all</code>. Ecto’s <code class="inline">Repo.update_all</code> allows us to perform batch updates against the database, and is perfect for atomically updating values, such as incrementing our views count. The result of the repo operation returns the number of updated records, along with the selected schema values specified by the <code class="inline">returning</code> option. When we receive the new page views, we use <code class="inline">put_in(page.views, views)</code> to place the new view count within the page.</p>
<p>With our context function in place, let’s make use of it in our CMS page controller. Update your <code class="inline">show</code> action in <code class="inline">lib/hello_web/controllers/cms/page_controller.ex</code> to call our new function:</p>
<pre><code class="nohighlight makeup"><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="6017403800-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6017403800-2">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="6017403800-2">}</span><span class="p" data-group-id="6017403800-1">)</span><span class="w"> </span><span class="k" data-group-id="6017403800-3">do</span><span class="w">
  </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="n">id</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">get_page!</span><span class="p" data-group-id="6017403800-4">(</span><span class="p" data-group-id="6017403800-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">inc_page_views</span><span class="p" data-group-id="6017403800-5">(</span><span class="p" data-group-id="6017403800-5">)</span><span class="w">

  </span><span class="n">render</span><span class="p" data-group-id="6017403800-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;show.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">page</span><span class="p">:</span><span class="w"> </span><span class="n">page</span><span class="p" data-group-id="6017403800-6">)</span><span class="w">
</span><span class="k" data-group-id="6017403800-3">end</span></code></pre>
<p>We modified our <code class="inline">show</code> action to pipe our fetched page into <code class="inline">CMS.inc_page_views/1</code>, which will return the updated page. Then we rendered our template just as before. Let’s try it out. Refresh one of your pages a few times and watch the view count increase.</p>
<p>We can also see our atomic update in action in the ecto debug logs:</p>
<pre><code class="">[debug] QUERY OK source=&quot;pages&quot; db=3.1ms
UPDATE &quot;pages&quot; AS p0 SET &quot;views&quot; = p0.&quot;views&quot; + $1 WHERE (p0.&quot;id&quot; = $2)
RETURNING p0.&quot;views&quot; [1, 3]</code></pre>
<p>Good work!</p>
<p>As we’ve seen, designing with contexts gives you a solid foundation to grow your application from. Using discrete, well-defined APIs that expose the intent of your system allows you to write more maintainable applications with reusable code.</p>
<h2 id="faq" class="section-heading">
  <a href="#faq" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  FAQ
</h2>

<h3 id="returning-ecto-structures-from-context-apis" class="section-heading">
  <a href="#returning-ecto-structures-from-context-apis" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Returning Ecto structures from context APIs
</h3>

<p>As we explored the context API, you might have wondered:</p>
<blockquote><p>If one of the goals of our context is to encapsulate Ecto Repo access, why does <code class="inline">create_user/1</code> return an <code class="inline">Ecto.Changeset</code> struct when we fail to create a user?</p>
</blockquote>
<p>The answer is we’ve decided to expose <code class="inline">%Ecto.Changeset{}</code> as a public <em>data-structure</em> in our application. We saw before how changesets allow us to track field changes, perform validations, and generate error messages. Its use here is decoupled from the private Repo access and Ecto changeset API internals. We’re exposing a data structure that the caller understands which contains the rich information like field errors. Conveniently for us, the <code class="inline">phoenix_ecto</code> project implements the necessary <a href="Phoenix.Param.html"><code class="inline">Phoenix.Param</code></a> and <a href="https://hexdocs.pm/phoenix_html/Phoenix.HTML.FormData.html"><code class="inline">Phoenix.HTML.FormData</code></a> protocols which know how to handle <code class="inline">%Ecto.Changeset{}</code>’s for things like form generation and error messages. You can also think about it as being as if you had defined your own <code class="inline">%Accounts.Changes{}</code> struct for the same purpose and implemented the Phoenix protocols for the web-layer integration.</p>
<h3 id="strategies-for-cross-context-workflows" class="section-heading">
  <a href="#strategies-for-cross-context-workflows" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Strategies for cross-context workflows
</h3>

<p>Our CMS context supports lazily creating authors in the system when a user decides to publish page content. This makes sense for our use case because not all users of our system will be CMS authors. But what if our use case were for when all users of our app are indeed authors?</p>
<p>If we require a <code class="inline">CMS.Author</code> to exist every time an <code class="inline">Accounts.User</code> is created, we have to think carefully where to place this dependency. We know our <code class="inline">CMS</code> context depends on the <code class="inline">Accounts</code> context, but it’s important to avoid cyclic dependencies across our contexts. For example, imagine we changed our <code class="inline">Accounts.create_user</code> function to:</p>
<pre><code class="nohighlight makeup"><span class="kd">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p" data-group-id="8266097441-1">(</span><span class="n">attrs</span><span class="p" data-group-id="8266097441-1">)</span><span class="w"> </span><span class="k" data-group-id="8266097441-2">do</span><span class="w">
  </span><span class="p" data-group-id="8266097441-3">%</span><span class="nc" data-group-id="8266097441-3">User</span><span class="p" data-group-id="8266097441-3">{</span><span class="p" data-group-id="8266097441-3">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">User</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="8266097441-4">(</span><span class="n">attrs</span><span class="p" data-group-id="8266097441-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">cast_assoc</span><span class="p" data-group-id="8266097441-5">(</span><span class="ss">:credential</span><span class="p">,</span><span class="w"> </span><span class="ss">with</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">Credential</span><span class="o">.</span><span class="n">changeset</span><span class="o">/</span><span class="mi">2</span><span class="p" data-group-id="8266097441-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_assoc</span><span class="p" data-group-id="8266097441-6">(</span><span class="ss">:author</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8266097441-7">%</span><span class="nc" data-group-id="8266097441-7">Author</span><span class="p" data-group-id="8266097441-7">{</span><span class="n">...</span><span class="p" data-group-id="8266097441-7">}</span><span class="p" data-group-id="8266097441-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="8266097441-8">(</span><span class="p" data-group-id="8266097441-8">)</span><span class="w">
</span><span class="k" data-group-id="8266097441-2">end</span></code></pre>
<p>This may accomplish what we want, but now we need to wire up the schema relationships in the <code class="inline">Accounts</code> context to the <code class="inline">CMS</code> author. Worse, we have now taken our isolated <code class="inline">Accounts</code> context and required it to know about a content management system. This isn’t what we want for isolated responsibilities in our application. There’s a better way to handle these requirements.</p>
<p>If you find yourself in similar situations where you feel your use case is requiring you to create circular dependencies across contexts, it’s a sign you need a new context in the system to handle these application requirements. In our case, what we really want is an interface that handles all requirements when a user is created or registers in our application. To handle this, we could create a <code class="inline">UserRegistration</code> context, which calls into both the <code class="inline">Accounts</code> and <code class="inline">CMS</code> APIs to create a user, then associate a CMS author. Not only would this allow our Accounts to remain as isolated as possible, it gives us a clear, obvious API to handle <code class="inline">UserRegistration</code> needs in the system. If you take this approach, you can also use tools like <code class="inline">Ecto.Multi</code> to handle transactions across different context operations without deeply coupling the internal database calls. Part of our <code class="inline">UserRegistration</code> API could look something like this:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Hello.UserRegistration</span><span class="w"> </span><span class="k" data-group-id="3302042257-1">do</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello</span><span class="o">.</span><span class="p" data-group-id="3302042257-2">{</span><span class="nc">Accounts</span><span class="p">,</span><span class="w"> </span><span class="nc">CMS</span><span class="p" data-group-id="3302042257-2">}</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p" data-group-id="3302042257-3">(</span><span class="n">params</span><span class="p" data-group-id="3302042257-3">)</span><span class="w"> </span><span class="k" data-group-id="3302042257-4">do</span><span class="w">
    </span><span class="nc">Multi</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="3302042257-5">(</span><span class="p" data-group-id="3302042257-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="3302042257-6">(</span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3302042257-7">fn</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">create_user</span><span class="p" data-group-id="3302042257-8">(</span><span class="n">params</span><span class="p" data-group-id="3302042257-8">)</span><span class="w"> </span><span class="k" data-group-id="3302042257-7">end</span><span class="p" data-group-id="3302042257-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="3302042257-9">(</span><span class="ss">:author</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3302042257-10">fn</span><span class="w"> </span><span class="p" data-group-id="3302042257-11">%{</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="3302042257-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="3302042257-12">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">CMS</span><span class="o">.</span><span class="n">ensure_author_exists</span><span class="p" data-group-id="3302042257-13">(</span><span class="n">user</span><span class="p" data-group-id="3302042257-13">)</span><span class="p" data-group-id="3302042257-12">}</span><span class="w">
    </span><span class="k" data-group-id="3302042257-10">end</span><span class="p" data-group-id="3302042257-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p" data-group-id="3302042257-14">(</span><span class="p" data-group-id="3302042257-14">)</span><span class="w">
  </span><span class="k" data-group-id="3302042257-4">end</span><span class="w">
</span><span class="k" data-group-id="3302042257-1">end</span></code></pre>
<p>We can take advantage of <code class="inline">Ecto.Multi</code> to create a pipeline of operations that can be run inside a transaction of our <code class="inline">Repo</code>. If any given operation fails, the transaction will be rolled back and an error will be returned containing which operation failed, as well as the changes up to that point. In our <code class="inline">register_user/1</code> example, we specified two operations, one that calls into <code class="inline">Accounts.create_user/1</code> and another that passes the newly created user to <code class="inline">CMS.ensure_author_exits/1</code>. The final step of our function is to invoke the operations with <code class="inline">Repo.transaction/1</code>.</p>
<p>The <code class="inline">UserRegistration</code> setup is likely simpler to implement than the dynamic author system we built – we decided to take the harder path exactly because those are decisions developers take on their applications every day.</p>

      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" rel="help" target="_blank">ExDoc</a> (v0.18.3),
          </span>
          <span class="line">
            designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" title="@dignifiedquire">Friedel Ziegelmayer</a>.
            </span>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>
  <script src="dist/app-9bd040e5e5.js"></script>
  
  <script src="dist/ex_doc_makeup-js.js"></script>
  
  
  </body>
</html>

